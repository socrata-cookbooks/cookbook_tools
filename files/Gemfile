# frozen_string_literal: true

paths = ENV['PATH'].split(':')
chef_product = if paths.find { |p| p.match?(%r{/chef-workstation/bin$}) }
                 'chef-workstation'
               elsif paths.find { |p| p.match?(%r{/chefdk/bin$}) }
                 'chefdk'
               else
                 raise('This cookbook requires Chef Workstation or the Chef ' \
                       'Development Kit')
               end

source 'https://rubygems.org'

addon_gems = {
  'kitchen-microwave' => nil,
  'rubocop' => '>=0.55',
  'simplecov-console' => nil
}

chef_path = if RUBY_PLATFORM.match?(/mswin|mingw|windows/)
              "C:\\opscode\\#{chef_product}\\bin\\chef"
            else
              "/opt/#{chef_product}/bin/chef"
            end

File.read(chef_path).lines.each do |line|
  next unless line.strip.start_with?('gem ')
  name, _, version = line.split('"')[1..3]
  next if addon_gems.key?(name)
  gem name, version
end

addon_gems.each do |name, version|
  gem name, version
end
